trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  - name: NODE_VERSION
    value: '20'
  - name: REGISTRY
    value: 'ghcr.io'
  - name: GITHUB_ACTOR
    value: 'pmanavella'
  - group: SONAR_TOKEN

stages:
# ──────────────────────────────
# 1️⃣ CI: Tests + SonarCloud
# ──────────────────────────────
- stage: CI
  displayName: 'CI: Tests + Sonar'
  jobs:
    - job: quality
      displayName: 'Quality'
      steps:
        - checkout: self
          clean: true

        - task: NodeTool@0
          inputs:
            versionSpec: '$(NODE_VERSION)'
          displayName: 'Use Node $(NODE_VERSION)'

        - task: SonarCloudPrepare@3
          displayName: 'Sonar • Prepare'
          inputs:
            SonarCloud: 'SonarCloud'
            organization: '$(SONAR_ORG)'
            scannerMode: 'CLI'
            configMode: 'file'

        - script: |
            set -e
            cd frontend
            npm ci
            npm run test:cov || echo "Vitest warnings, continuamos..."
          displayName: 'Frontend • Vitest + Coverage'

        - task: PublishCodeCoverageResults@2
          displayName: 'Frontend • Publicar Coverage'
          inputs:
            codeCoverageTool: Cobertura
            summaryFileLocation: 'frontend/coverage/cobertura-coverage.xml'
            reportDirectory: 'frontend/coverage'
            failIfCoverageEmpty: false
          condition: always()

        - script: |
            set -e
            cd backend
            npm ci
            npm run test:cov || echo "Jest warnings, continuamos..."
          displayName: 'Backend • Jest + Coverage'

        - task: PublishCodeCoverageResults@2
          displayName: 'Backend • Publicar Coverage'
          inputs:
            codeCoverageTool: Cobertura
            summaryFileLocation: 'backend/coverage/cobertura-coverage.xml'
            reportDirectory: 'backend/coverage'
            failIfCoverageEmpty: false
          condition: always()

        - task: SonarCloudAnalyze@3
          displayName: 'Sonar • Analyze'

        - task: SonarCloudPublish@3
          displayName: 'Sonar • Quality Gate'
          inputs:
            pollingTimeoutSec: '300'

# ──────────────────────────────
# 2️⃣ QA: Build + Push + Deploy
# ──────────────────────────────
- stage: QA
  displayName: 'QA: Build & Push + Deploy QA'
  dependsOn: CI
  condition: succeeded()
  jobs:
    - job: build_push_qa
      displayName: 'Build & Push (latest + sha) + Deploy QA'
      steps:
        - checkout: self

        - script: |
            echo "$GHCR_TOKEN" | docker login $(REGISTRY) -u $(GITHUB_ACTOR) --password-stdin
          env:
            GHCR_TOKEN: $(GHCR_TOKEN)
          displayName: 'Login GHCR'

        - script: |
            SHORT_SHA=$(echo $(Build.SourceVersion) | cut -c1-7)
            echo "SHORT_SHA=$SHORT_SHA" > meta.txt
            cat meta.txt
          displayName: 'Compute short sha'

        - script: |
            SHA=$(grep SHORT_SHA meta.txt | cut -d'=' -f2)
            docker build -t $(REGISTRY)/$(GITHUB_ACTOR)/books-backend:latest \
                          -t $(REGISTRY)/$(GITHUB_ACTOR)/books-backend:sha-$SHA \
                          backend
            docker push $(REGISTRY)/$(GITHUB_ACTOR)/books-backend:latest
            docker push $(REGISTRY)/$(GITHUB_ACTOR)/books-backend:sha-$SHA
          displayName: 'Backend • Build & Push'

        - script: |
            SHA=$(grep SHORT_SHA meta.txt | cut -d'=' -f2)
            docker build \
              --build-arg VITE_ENV=qa \
              -t $(REGISTRY)/$(GITHUB_ACTOR)/books-frontend:latest \
              -t $(REGISTRY)/$(GITHUB_ACTOR)/books-frontend:sha-$SHA \
              frontend
            docker push $(REGISTRY)/$(GITHUB_ACTOR)/books-frontend:latest
            docker push $(REGISTRY)/$(GITHUB_ACTOR)/books-frontend:sha-$SHA
          displayName: 'Frontend QA • Build (VITE_ENV=qa) & Push'

        - script: |
            echo "Trigger Render FRONT QA"
            curl -fsS -X POST "$(RENDER_QA_HOOK_FRONT)"
            echo "Trigger Render BACK QA"
            curl -fsS -X POST "$(RENDER_QA_HOOK_BACK)"
          displayName: 'Deploy QA (Render hooks)'

        - script: |
            if [ -z "$(FRONT_QA_URL)" ]; then
              echo "FRONT_QA_URL no está seteada; se omite Cypress."
              exit 0
            fi
            cd frontend
            npm ci
            npx cypress install
            CYPRESS_BASE_URL=$(FRONT_QA_URL) npm run cy:run
          displayName: 'Cypress E2E (QA)'
          condition: succeeded()

# ──────────────────────────────
# 3️⃣ PROD: Approval + Deploy (deployment job)
# ──────────────────────────────
- stage: PROD
  displayName: 'PROD: Approval → Promote & Deploy'
  dependsOn: QA
  condition: succeeded()
  jobs:
    - deployment: promote_prod               # <-- deployment job (reemplaza "job:")
      displayName: 'Promote to :prod + Deploy PROD'
      environment: 'prod'                    # <-- ahora sí, aquí va el Environment con Approval
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self

              - script: |
                  echo "$GHCR_TOKEN" | docker login $(REGISTRY) -u $(GITHUB_ACTOR) --password-stdin
                env:
                  GHCR_TOKEN: $(GHCR_TOKEN)
                displayName: 'Login GHCR'

              # Backend → promover a :prod (desde latest)
              - script: |
                  docker pull $(REGISTRY)/$(GITHUB_ACTOR)/books-backend:latest
                  docker tag  $(REGISTRY)/$(GITHUB_ACTOR)/books-backend:latest $(REGISTRY)/$(GITHUB_ACTOR)/books-backend:prod
                  docker push $(REGISTRY)/$(GITHUB_ACTOR)/books-backend:prod
                displayName: 'Backend • Promote to :prod'

              # Frontend PROD → build con VITE_ENV=prod y push :prod
              - script: |
                  docker build \
                    --build-arg VITE_ENV=prod \
                    -t $(REGISTRY)/$(GITHUB_ACTOR)/books-frontend:prod \
                    frontend
                  docker push $(REGISTRY)/$(GITHUB_ACTOR)/books-frontend:prod
                displayName: 'Frontend PROD • Build (VITE_ENV=prod) & Push :prod'

              # Despliegue PROD (hooks de Render)
              - script: |
                  echo "Trigger Render FRONT PROD"
                  curl -fsS -X POST "$(RENDER_PROD_HOOK_FRONT)"
                  echo "Trigger Render BACK PROD"
                  curl -fsS -X POST "$(RENDER_PROD_HOOK_BACK)"
                displayName: 'Deploy PROD (Render hooks)'
