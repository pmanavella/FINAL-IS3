trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  - name: NODE_VERSION
    value: '20'
  # Variable group con SONAR_ORG, SONAR_PROJECT_KEY, SONAR_TOKEN (si lo usás)
  - group: SONAR_TOKEN

steps:
  - checkout: self
    clean: true

  - task: NodeTool@0
    inputs:
      versionSpec: '$(NODE_VERSION)'
    displayName: Use Node $(NODE_VERSION)

  # --- Sonar: preparar (lee sonar-project.properties de la raíz) ---
  - task: SonarCloudPrepare@3
    displayName: Sonar • Prepare
    inputs:
      SonarCloud: 'SonarCloud'      # nombre de tu Service Connection
      organization: '$(SONAR_ORG)'
      scannerMode: 'CLI'
      configMode: 'file'             # usa sonar-project.properties

  # --- Frontend: Vitest + Coverage ---
  - script: |
      cd frontend
      npm ci
      npm run test:cov               # vitest run --coverage (lcov + cobertura)
    displayName: Frontend • Vitest + Coverage

  - task: PublishCodeCoverageResults@2
    displayName: Frontend • Publicar Coverage
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: 'frontend/coverage/cobertura-coverage.xml'
      reportDirectory: 'frontend/coverage'
    condition: succeededOrFailed()

  # --- Backend: Jest + Coverage ---
  - script: |
      cd backend
      npm ci
      npm run test:cov               # jest --coverage (lcov + cobertura)
    displayName: Backend • Jest + Coverage

  - task: PublishCodeCoverageResults@2
    displayName: Backend • Publicar Coverage
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: 'backend/coverage/cobertura-coverage.xml'
      reportDirectory: 'backend/coverage'
    condition: succeededOrFailed()

  # --- Sonar: analizar y evaluar el gate (corta si falla) ---
  - task: SonarCloudAnalyze@3
    displayName: Sonar • Analyze

  - task: SonarCloudPublish@3
    displayName: Sonar • Quality Gate
    inputs:
      pollingTimeoutSec: '300'

  # --- Cypress E2E contra QA ---
  - script: |
      cd frontend
      npm ci
      npx cypress install
      CYPRESS_BASE_URL=https://tu-frontend-qa.onrender.com npm run cy:run
    displayName: Cypress E2E (QA)
    condition: succeeded()   # solo si todo lo anterior pasó


