trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  - name: NODE_VERSION
    value: '20'
  # üëâ Variable group con SONAR_ORG, SONAR_PROJECT_KEY, SONAR_TOKEN, FRONT_QA_URL (opcional para Cypress)
  - group: SONAR_TOKEN

steps:
  - checkout: self
    clean: true

  - task: NodeTool@0
    displayName: "Use Node $(NODE_VERSION)"
    inputs:
      versionSpec: "$(NODE_VERSION)"

  # -----------------------------
  # SonarCloud - Prepare (lee sonar-project.properties en la ra√≠z)
  # -----------------------------
  - task: SonarCloudPrepare@3
    displayName: "Sonar ‚Ä¢ Prepare"
    inputs:
      SonarCloud: "SonarCloud"          # nombre de tu Service Connection
      organization: "$(SONAR_ORG)"
      scannerMode: "CLI"
      configMode: "file"                 # usa sonar-project.properties

  # -----------------------------
  # Frontend - Vitest + Coverage
  # -----------------------------
  - script: |
      set -e
      cd frontend
      npm ci
      npm run test:cov || echo "Vitest devolvi√≥ exit code != 0 (warnings). Continuamos..."
    displayName: "Frontend ‚Ä¢ Vitest + Coverage"

  - task: PublishCodeCoverageResults@2
    displayName: "Frontend ‚Ä¢ Publicar Coverage"
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: "frontend/coverage/cobertura-coverage.xml"
      reportDirectory: "frontend/coverage"
      failIfCoverageEmpty: false
    condition: always()   # public√° aunque el paso anterior haya dado warning

  # -----------------------------
  # Backend - Jest + Coverage
  # -----------------------------
  - script: |
      set -e
      cd backend
      npm ci
      npm run test:cov || echo "Jest devolvi√≥ exit code != 0 (warnings). Continuamos..."
    displayName: "Backend ‚Ä¢ Jest + Coverage"

  - task: PublishCodeCoverageResults@2
    displayName: "Backend ‚Ä¢ Publicar Coverage"
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: "backend/coverage/cobertura-coverage.xml"
      reportDirectory: "backend/coverage"
      failIfCoverageEmpty: false
    condition: always()

  # -----------------------------
  # SonarCloud - Analyze + Quality Gate
  # -----------------------------
  - task: SonarCloudAnalyze@3
    displayName: "Sonar ‚Ä¢ Analyze"

  - task: SonarCloudPublish@3
    displayName: "Sonar ‚Ä¢ Quality Gate"
    inputs:
      pollingTimeoutSec: "300"

  # -----------------------------
  # Cypress E2E contra Front QA (opcional)
  # Para habilitarlo, defin√≠ FRONT_QA_URL en tu Variable Group SONAR_TOKEN
  # -----------------------------
  - script: |
      if [ -z "$(FRONT_QA_URL)" ]; then
        echo "FRONT_QA_URL no est√° seteada; se omite Cypress."
        exit 0
      fi
      cd frontend
      npm ci
      npx cypress install
      CYPRESS_BASE_URL=$(FRONT_QA_URL) npm run cy:run
    displayName: "Cypress E2E (QA)"
    condition: succeeded()   # solo si todo lo anterior pas√≥
