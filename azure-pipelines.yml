trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  - name: NODE_VERSION
    value: '20'
  - name: REGISTRY
    value: 'ghcr.io'
  - name: GITHUB_ACTOR
    value: 'pmanavella'
  - name: DEPLOY_RENDER
    value: 'true'
  - group: SONAR_TOKEN
  - group: GHCR_SECRETS
  - group: RENDER_HOOKS   # INCLUYE: BACK_QA_URL, BACK_PROD_URL, FRONT_QA_URL, HOOKS

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) CI: Tests + Sonar
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
stages:
- stage: CI
  displayName: 'CI: Tests + Sonar'
  jobs:
    - job: quality
      displayName: 'Quality'
      steps:
        - checkout: self
          clean: true

        - task: NodeTool@0
          displayName: 'Use Node $(NODE_VERSION)'
          inputs:
            versionSpec: '$(NODE_VERSION)'

        - task: SonarCloudPrepare@3
          displayName: 'Sonar â€¢ Prepare'
          inputs:
            SonarCloud: 'SonarCloud'
            organization: 'pmanavella'
            projectKey: 'FINAL-IS3'
            scannerMode: 'CLI'
            configMode: 'file'

        # Frontend tests + coverage
        - script: |
            set -e
            cd frontend
            npm ci
            npm run test:cov || echo "Vitest warnings, continuamos..."
          displayName: 'Frontend â€¢ Vitest + Coverage'

        - task: PublishCodeCoverageResults@2
          displayName: 'Frontend â€¢ Publicar Coverage'
          inputs:
            codeCoverageTool: Cobertura
            summaryFileLocation: 'frontend/coverage/cobertura-coverage.xml'
            reportDirectory: 'frontend/coverage'
            failIfCoverageEmpty: false
          condition: always()

        # Backend tests + coverage
        - script: |
            set -e
            cd backend
            npm ci
            npm run test:cov || echo "Jest warnings, continuamos..."
          displayName: 'Backend â€¢ Jest + Coverage'

        - task: PublishCodeCoverageResults@2
          displayName: 'Backend â€¢ Publicar Coverage'
          inputs:
            codeCoverageTool: Cobertura
            summaryFileLocation: 'backend/coverage/cobertura-coverage.xml'
            reportDirectory: 'backend/coverage'
            failIfCoverageEmpty: false
          condition: always()

        - task: SonarCloudAnalyze@3
        - task: SonarCloudPublish@3
          inputs:
            pollingTimeoutSec: '300'

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) QA: Build + Push + Deploy
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: QA
  displayName: 'QA: Build & Push (+ Deploy)'
  dependsOn: CI
  condition: succeeded()
  jobs:
    - job: build_push_qa
      displayName: 'Build & Push (latest + sha) + Deploy QA'
      steps:
        - checkout: self
          clean: true

        # Login a GHCR
        - bash: |
            echo "$GHCR_TOKEN" | docker login "$REGISTRY" -u "$GHCR_USERNAME" --password-stdin
          displayName: 'Login GHCR'
          env:
            GHCR_TOKEN: $(GHCR_TOKEN)
            GHCR_USERNAME: $(GHCR_USERNAME)

        # Short SHA
        - bash: |
            SHORT_SHA="$(echo $(Build.SourceVersion) | cut -c1-7)"
            echo "SHORT_SHA=$SHORT_SHA" > meta.txt
          displayName: 'Compute short sha'

        # Backend build
        - bash: |
            SHA="$(grep SHORT_SHA meta.txt | cut -d'=' -f2)"
            docker build -t $(REGISTRY)/$(GITHUB_ACTOR)/books-backend:latest \
                          -t $(REGISTRY)/$(GITHUB_ACTOR)/books-backend:sha-$SHA \
                          backend
            docker push $(REGISTRY)/$(GITHUB_ACTOR)/books-backend:latest
            docker push $(REGISTRY)/$(GITHUB_ACTOR)/books-backend:sha-$SHA
          displayName: 'Backend â€¢ Build & Push'

        # Frontend build (inyectando la API de QA)
        - bash: |
            SHA="$(grep SHORT_SHA meta.txt | cut -d'=' -f2)"

            docker build \
              --build-arg VITE_API_URL=$(BACK_QA_URL) \
              -t $(REGISTRY)/$(GITHUB_ACTOR)/books-frontend:latest \
              -t $(REGISTRY)/$(GITHUB_ACTOR)/books-frontend:sha-$SHA \
              frontend

            docker push $(REGISTRY)/$(GITHUB_ACTOR)/books-frontend:latest
            docker push $(REGISTRY)/$(GITHUB_ACTOR)/books-frontend:sha-$SHA
          displayName: 'Frontend QA â€¢ Build (VITE_API_URL) & Push'

        # Deploy QA a Render
        - bash: |
            if [ -z "$RENDER_QA_HOOK_FRONT" ] || [ -z "$RENDER_QA_HOOK_BACK" ]; then
              echo "Saltando deploy QA: faltan hooks"
              exit 0
            fi

            echo "ðŸš€ Trigger Render FRONT QA"
            curl -fsS -X POST "$RENDER_QA_HOOK_FRONT"

            echo "ðŸš€ Trigger Render BACK QA"
            curl -fsS -X POST "$RENDER_QA_HOOK_BACK"
          displayName: 'Deploy QA (Render)'
          env:
            RENDER_QA_HOOK_FRONT: $(RENDER_QA_HOOK_FRONT)
            RENDER_QA_HOOK_BACK: $(RENDER_QA_HOOK_BACK)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3) PROD: Approval â†’ Promote + Deploy
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: PROD
  displayName: 'PROD: Approval â†’ Promote & Deploy'
  dependsOn: QA
  condition: succeeded()
  jobs:
    - deployment: promote_prod
      displayName: 'Promote + Deploy PROD'
      environment: 'prod'
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self

              # Login GHCR
              - bash: |
                  echo "$GHCR_TOKEN" | docker login "$REGISTRY" -u "$GHCR_USERNAME" --password-stdin
                env:
                  GHCR_TOKEN: $(GHCR_TOKEN)
                  GHCR_USERNAME: $(GHCR_USERNAME)

              # Promote backend latest â†’ prod
              - bash: |
                  docker pull $(REGISTRY)/$(GITHUB_ACTOR)/books-backend:latest
                  docker tag $(REGISTRY)/$(GITHUB_ACTOR)/books-backend:latest $(REGISTRY)/$(GITHUB_ACTOR)/books-backend:prod
                  docker push $(REGISTRY)/$(GITHUB_ACTOR)/books-backend:prod
                displayName: 'Backend â€¢ Promote'

              # Build frontend para PROD con su API
              - bash: |
                  docker build \
                    --build-arg VITE_API_URL=$(BACK_PROD_URL) \
                    -t $(REGISTRY)/$(GITHUB_ACTOR)/books-frontend:prod \
                    frontend

                  docker push $(REGISTRY)/$(GITHUB_ACTOR)/books-frontend:prod
                displayName: 'Frontend PROD â€¢ Build (VITE_API_URL) & Push'

              # Deploy PROD en Render
              - bash: |
                  echo "ðŸš€ Trigger FRONT PROD"
                  curl -fsS -X POST "$RENDER_PROD_HOOK_FRONT"

                  echo "ðŸš€ Trigger BACK PROD"
                  curl -fsS -X POST "$RENDER_PROD_HOOK_BACK"
                displayName: 'Deploy PROD (Render)'
                env:
                  RENDER_PROD_HOOK_FRONT: $(RENDER_PROD_HOOK_FRONT)
                  RENDER_PROD_HOOK_BACK: $(RENDER_PROD_HOOK_BACK)
