trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  NODE_VERSION: '20'

# Importa el grupo de variables SONAR_TOKEN (ORG, PROJECT_KEY, TOKEN)
- group: SONAR_TOKEN

steps:
  - checkout: self
    clean: true

  - task: NodeTool@0
    inputs:
      versionSpec: '$(NODE_VERSION)'

  # ==== Backend: Tests + Coverage ====
  - script: |
      cd backend
      npm ci || npm install
      npm test
    displayName: Backend • Jest + Coverage

  - task: PublishCodeCoverageResults@2
    displayName: Backend • Publicar Coverage
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: 'backend/coverage/cobertura-coverage.xml'
      reportDirectory: 'backend/coverage'
    condition: succeededOrFailed()

  # ==== Frontend: Tests (si los tenés) ====
  - script: |
      cd frontend
      npm ci || npm install
      npm run test || echo "Sin tests de frontend configurados"
    displayName: Frontend • Vitest

  # ==== SonarCloud ====

  - task: SonarCloudPrepare@1
    displayName: SonarCloud • Prepare
    inputs:
      SonarCloud: 'SonarCloud'
      organization: '$(SONAR_ORG)'
      scannerMode: 'Other'
      configMode: 'manual'
      cliProjectKey: '$(SONAR_PROJECT_KEY)'
      cliProjectName: '$(SONAR_PROJECT_KEY)'

  - script: |
      npx sonar-scanner \
        -Dsonar.organization=$(SONAR_ORG) \
        -Dsonar.projectKey=$(SONAR_PROJECT_KEY) \
        -Dsonar.host.url=https://sonarcloud.io \
        -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info \
        -Dsonar.login=$(SONAR_TOKEN)
    displayName: SonarCloud • Analyze

  - task: SonarCloudPublish@1
    displayName: SonarCloud • Publish Quality Gate
    inputs:
      pollingTimeoutSec: '300'
