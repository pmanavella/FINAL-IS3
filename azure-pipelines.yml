trigger:
  - main

pool:
  vmImage: ubuntu-latest

variables:
  - name: NODE_VERSION
    value: '20'
  - group: SONAR_TOKEN   # (SONAR_TOKEN, SONAR_ORG, SONAR_PROJECT_KEY)

steps:
  - checkout: self
    clean: true

  - task: NodeTool@0
    inputs:
      versionSpec: '$(NODE_VERSION)'

  # ==== Backend: Jest + Coverage ====
  - script: |
      cd backend
      npm ci || npm install
      npm test
    displayName: Backend • Jest + Coverage

  - task: PublishCodeCoverageResults@2
    displayName: Backend • Publicar Coverage
    condition: exists('backend/coverage/cobertura-coverage.xml')
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: 'backend/coverage/cobertura-coverage.xml'
      reportDirectory: 'backend/coverage'

  # ==== Frontend: Vitest (si está configurado) ====
  - script: |
      cd frontend
      npm ci || npm install
      npm run test || echo "Sin tests de frontend configurados"
    displayName: Frontend • Vitest

  # ==== SonarCloud ====
  - task: SonarCloudPrepare@1
    displayName: Sonar • Prepare
    inputs:
      SonarCloud: 'SonarCloud'
      organization: '$(SONAR_ORG)'
      scannerMode: 'Other'
      configMode: 'manual'
      cliProjectKey: '$(SONAR_PROJECT_KEY)'
      cliProjectName: '$(SONAR_PROJECT_KEY)'

  - script: |
      npx sonar-scanner \
        -Dsonar.organization=$(SONAR_ORG) \
        -Dsonar.projectKey=$(SONAR_PROJECT_KEY) \
        -Dsonar.host.url=https://sonarcloud.io \
        -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info \
        -Dsonar.login=$(SONAR_TOKEN)
    displayName: Sonar • Analyze

  - task: SonarCloudPublish@1
    displayName: Sonar • Quality Gate
    inputs:
      pollingTimeoutSec: '300'
